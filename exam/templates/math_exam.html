{% extends "base.html" %}
{% block content %}

<!-- ===== STUDENT NAME BANNER ===== -->
<div id="studentBanner"
     style="background:#C9A227;padding:10px;color:black;font-weight:bold;display:none;">
</div>

<!-- ===== TIMER ===== -->
<div id="timerBox" style="font-size:18px;color:red;font-weight:bold;text-align:right;">
‚è≥ Time Remaining: <span id="timeDisplay"></span>
</div>

<h2>Mathematics Entrance Examination</h2>

<form method="POST" id="examForm">
{% csrf_token %}

<label><b>Student Name:</b></label><br>
<input type="text" name="student_name" required><br><br>

<label><b>Email:</b></label><br>
<input type="email" name="student_email" required><br><br>

<!-- ====== RANDOM SHUFFLED QUESTIONS ====== -->
{% for q in questions %}
<input type="hidden" name="question_ids" value="{{ q.id }}">

<h3>{{ forloop.counter }}. {{ q.question }}</h3>

{% for key,value in q.shuffled %}
    <input type="radio" name="{{ q.id }}" value="{{ key }}" required>
    {{ key }}) {{ value }} <br>
{% endfor %}
{% endfor %}

<br>
<button type="submit" id="submitBtn">Submit Exam</button>
</form>


<!-- =============================== -->
<!-- ===== RESUME + TIMER JS ===== -->
<!-- =============================== -->
<script>
// ================= SETTINGS =================
const EXAM_KEY = window.location.pathname.includes("math")
    ? "ciu_math_exam"
    : "ciu_english_exam";


// ================= LOAD SAVED DATA =================
let savedData = JSON.parse(localStorage.getItem(EXAM_KEY)) || {};

let timeLeft = savedData.timeLeft ?? 90 * 60;
const display = document.getElementById("timeDisplay");
const form = document.getElementById("examForm");
const submitBtn = document.getElementById("submitBtn");


// ========== Restore Name + Banner ==========
if(savedData.name){
    document.querySelector("input[name='student_name']").value = savedData.name;
    document.getElementById("studentBanner").style.display="block";
    document.getElementById("studentBanner").innerHTML = "Candidate: " + savedData.name;
}

if(savedData.email){
    document.querySelector("input[name='student_email']").value = savedData.email;
}


// ========== Restore Answers ==========
if(savedData.answers){
    Object.entries(savedData.answers).forEach(([qid, value])=>{
        let input = document.querySelector(`input[name='${qid}'][value='${value}']`);
        if(input){
            input.checked = true;
        }
    });
}


// ================= TIMER =================
function format(seconds){
    let m = Math.floor(seconds / 60);
    let s = seconds % 60;
    return m + ":" + (s < 10 ? "0" + s : s);
}

display.innerHTML = format(timeLeft);

let countdown = setInterval(()=>{
    timeLeft--;
    display.innerHTML = format(timeLeft);

    savedData.timeLeft = timeLeft;
    localStorage.setItem(EXAM_KEY, JSON.stringify(savedData));

    if(timeLeft <= 0){
        clearInterval(countdown);
        alert("Time is up! Your exam is being submitted.");
        submitBtn.disabled = true;
        form.submit();
    }

},1000);


// ================= SAVE ON INPUT =================
document.querySelector("input[name='student_name']").addEventListener("keyup", e=>{
    savedData.name = e.target.value;
    localStorage.setItem(EXAM_KEY, JSON.stringify(savedData));

    if(e.target.value){
        document.getElementById("studentBanner").style.display="block";
        document.getElementById("studentBanner").innerHTML = "Candidate: " + e.target.value;
    }
});

document.querySelector("input[name='student_email']").addEventListener("keyup", e=>{
    savedData.email = e.target.value;
    localStorage.setItem(EXAM_KEY, JSON.stringify(savedData));
});


// Track answers
document.querySelectorAll("input[type='radio']").forEach(r=>{
    r.addEventListener("change", ()=>{
        if(!savedData.answers) savedData.answers = {};
        savedData.answers[r.name] = r.value;
        localStorage.setItem(EXAM_KEY, JSON.stringify(savedData));
    });
});


// ================= PREVENT MULTIPLE SUBMISSIONS =================
let submitted = false;

form.addEventListener("submit", function(){
    if(submitted){
        alert("Exam already submitted. Please wait...");
        return false;
    }

    submitted = true;
    submitBtn.disabled = true;
    submitBtn.innerHTML = "Submitting...";

    // Clear storage only when successfully submitting
    localStorage.removeItem(EXAM_KEY);
});
</script>

{% endblock %}
